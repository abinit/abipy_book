---
jupytext:
  text_representation:
    extension: .md
    format_name: myst
    format_version: 0.13
    jupytext_version: 1.10.3
kernelspec:
  display_name: Python 3
  language: python
  name: python3
---

# The FATBANDS.nc file

The `FATBANDS.nc` file contains the projection of the KS wavefunctions onto atom-centered functions with given angular momentum $l$.
The file is generated by using the {{prtdos}} variable either in a SCF or NSCF run.

One can use the `abiopen` function provided by `abilab` to open the file and generate an instance of `FatbandsFile`.
Alternatively, use the `abiopen.py` script to open the file inside the shell with the syntax:

    abiopen.py out_FATBANDS.nc

This command will start the ipython interpreter so that one can interact directly
with the `FatbandFile` object (named `obj` inside ipython).

To generate a jupyter notebook use:

    abiopen.py out_FATBANDS.nc -nb

For a quick visualization of the data, use:

    abiopen.py out_FATBANDS.nc -e

```{include} snippets/plotly_matplotlib_note.md
```

```{code-cell}
import warnings
warnings.filterwarnings("ignore")  # Ignore warnings

from abipy import abilab
abilab.enable_notebook() # This line tells AbiPy we are running inside a notebook
import abipy.data as abidata

# This line configures matplotlib to show figures embedded in the notebook.
# Replace `inline` with `notebook` in classic notebook
%matplotlib inline

# Option available in jupyterlab. See https://github.com/matplotlib/jupyter-matplotlib
#%matplotlib widget
```

```{code-cell}
# This fatbands file has been produced on a k-path so it is not suitable for DOS calculations.
fbnc_kpath = abilab.abiopen(abidata.ref_file("mgb2_kpath_FATBANDS.nc"))
```

To print file info i.e., dimensions, variables, etc.
(note that prtdos = 3, so LM decomposition is not available)

```{code-cell}
print(fbnc_kpath)
```

```{code-cell}
fbnc_kpath.structure.plot();
```

To plot the k-points belonging to the path:

```{code-cell}
fbnc_kpath.ebands.kpoints.plotly();
```

To plot the electronic fatbands grouped by atomic type:

```{code-cell}
fbnc_kpath.plot_fatbands_typeview(tight_layout=True);
```

```{code-cell}
fbnc_kpath.plotly_fatbands_typeview();
```

To plot the electronic fatbands grouped by $l$:

```{code-cell}
fbnc_kpath.plot_fatbands_lview(tight_layout=True);
```

```{code-cell}
fbnc_kpath.plotly_fatbands_lview();
```

Now we read another FATBANDS.nc file produced on the 18x18x18 k-mesh

```{code-cell}
fbnc_kmesh = abilab.abiopen(abidata.ref_file("mgb2_kmesh181818_FATBANDS.nc"))
print(fbnc_kpath)
```

and plot the $l$-PJDOS grouped by atomic type:

```{code-cell}
fbnc_kmesh.plot_pjdos_typeview(tight_layout=True);
```

```{code-cell}
fbnc_kmesh.plotly_pjdos_typeview();
```

Plot the L-PJDOS grouped by L:

```{code-cell}
fbnc_kmesh.plot_pjdos_lview(tight_layout=True);
```

```{code-cell}
fbnc_kmesh.plotly_pjdos_lview();
```

Now we use the two netcdf files to produce plots with fatbands with PJDOSEs.
The data for the DOS is taken from pjdosfile.

```{code-cell}
fbnc_kpath.plot_fatbands_with_pjdos(pjdosfile=fbnc_kmesh, view="type", tight_layout=True);
```

```{code-cell}
fbnc_kpath.plotly_fatbands_with_pjdos(pjdosfile=fbnc_kmesh, view="type");
```

fatbands plut PJDOS grouped by L:

```{code-cell}
fbnc_kpath.plot_fatbands_with_pjdos(pjdosfile=fbnc_kmesh, view="lview", tight_layout=True);
```

```{code-cell}
fbnc_kpath.plotly_fatbands_with_pjdos(pjdosfile=fbnc_kmesh, view="lview");
```

```{warning}
Remember to close the files with:
```

```{code-cell}
fbnc_kpath.close()
fbnc_kmesh.close()
```
