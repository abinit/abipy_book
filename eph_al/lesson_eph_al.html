
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Isotropic superconductivity &#8212; AbiPy Book</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"TeX": {"Macros": {"*": "{\\dagger}", "ra": "{\\rangle}", "la": "{\\langle}", "bm": ["{\\boldsymbol #1}", 1], "mcL": "{\\mathcal{L}}", "mcG": "{\\mathcal{G}}", "mcR": "{\\mathcal{R}}", "mcS": "{\\mathcal{S}}", "mcC": "{\\mathcal{C}}", "mcO": "{\\mathcal{O}}", "KS": "{\\text{KS}}", "eph": "{\\text{e-ph}}", "ee": "{\\epsilon}", "phph": "{\\text{ph-ph}}", "FM": "{\\text{FM}}", "DW": "{\\text{DW}}", "QP": "{\\text{QP}}", "BZ": "{\\text{BZ}}", "sign": "{\\text{sign}}", "xc": "{\\text{xc}}", "tchi": "{\\tilde\\chi}", "rr": "{\\bf r}", "RR": "{\\bf R}", "tt": "{\\bf t}", "GG": "{\\bf G}", "kk": "{\\bf k}", "qq": "{\\bf q}", "kq": "{\\kk + \\qq}", "qG": "{\\bf q + G}", "kG": "{\\bf k + G}", "kmq": "{\\kk - \\qq}", "kpq": "{\\kk + \\qq}", "kpG": "{\\kk + \\GG}", "qpG": "{\\qq + \\GG}", "nk": "{n \\kk}", "mk": "{, \\kk}", "nks": "{n \\kk\\sigma}", "mks": "{m \\kk\\sigma}", "enk": "{\\varepsilon_\\nk}", "emkq": "{\\varepsilon_{m\\kk+\\qq}}", "qnu": "{\\qq \\nu}", "wqnu": "{\\omega_{\\qnu}}", "vnk": "{\\mathbf{v}_{n\\kk}}", "vmkq": "{\\mathbf{v}_{m\\kk+\\qq}}", "vnka": "{\\mathrm{v}_{n\\kk,\\alpha}}", "vnkb": "{\\mathrm{v}_{n\\kk,\\beta}}", "ef": "{\\varepsilon_F}", "gkkp": "{g_{mn\\nu}(\\kk,\\qq)}", "gkq": "{g_{mn\\nu}(\\kk,\\qq)}", "Go": "{G_0}", "Wo": "{W_0}", "Ueff": "{U_{\\text{eff}}}", "tee": "{\\tilde{\\epsilon}}", "ww": "{\\omega}", "tww": "{\\tilde\\omega}", "dd": "{\\,\\text{d}}", "vxc": "{v_\\xc}", "Ri": "{\\mcR^{-1}}", "Rit": "{\\mcR^{-1\\tau}}", "Si": "{\\mcS^{-1}}}", "Sit": "{\\Si^\\tau}}", "PDER": ["{\\dfrac{\\partial #1}{\\partial #2}}", 2], "FDER": ["{\\dfrac{\\delta #1}{\\delta #2}}", 2], "tPsi": "{\\tilde\\Psi}", "tpsi": "{\\tilde\\psi}", "tPhi": "{\\tilde\\Phi}", "tphi": "{\\tilde\\phi}", "tprj": "{\\tilde p}"}}, "tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Useful links" href="../links.html" />
    <link rel="prev" title="Bethe-Salpeter calculations with AbiPy" href="../bse/lesson_bse.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">AbiPy Book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Introduction
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Basic AbiPy Objects
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../structure.html">
   Structure object
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../abinit_input.html">
   The AbinitInput object
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../input_factories.html">
   Factory functions
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Output Files
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../gsr.html">
   The GSR file (Ground-State)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../hist.html">
   The HIST.nc file (relaxation/MD)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../efatbands.html">
   The FATBANDS.nc file
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ddb.html">
   The DDB file (DFPT)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../sigres.html">
   The SIGRES file (GW)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mdf.html">
   The MDF file (Bethe-Salpeter)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../abiwan.html">
   The ABIWAN file (wannier90)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lobster.html">
   Lobster output files
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  AbiPy Workflows
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../flows.html">
   Tasks, Workflows and Flow
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  AbiPy Lessons
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../base1/lesson_base1.html">
   Base1 lesson (H2 molecule)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../base3/lesson_base3.html">
   Base3 lesson (silicon)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../base4/lesson_base4.html">
   Base4 lesson (Aluminium)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dfpt/lesson_dfpt.html">
   Phonons and Born effective charges
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../g0w0/lesson_g0w0.html">
   <span class="math notranslate nohighlight">
    \(G_0W_0\)
   </span>
   band structure with star-function interpolation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../bse/lesson_bse.html">
   Bethe-Salpeter calculations with AbiPy
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Isotropic superconductivity
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Miscellaneous
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../links.html">
   Useful links
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/eph_al/lesson_eph_al.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/eph_al/lesson_eph_al.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/abinit/abipy_book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/abinit/abipy_book/issues/new?title=Issue%20on%20page%20%2Feph_al/lesson_eph_al.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/abinit/abipy_book/edit/master/docs/eph_al/lesson_eph_al.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/abinit/abipy_book/master?urlpath=tree/docs/eph_al/lesson_eph_al.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-bit-of-theory-and-some-details-about-the-implementation">
   A bit of theory and some details about the implementation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#implementation-details">
     Implementation details:
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#suggested-references">
   Suggested references
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#technical-details">
   Technical details
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#building-the-flow">
   Building the Flow
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#electronic-properties">
   Electronic properties
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#vibrational-properties">
   Vibrational properties
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#phonon-linewidths-and-eliashberg-function">
   Phonon linewidths and Eliashberg function
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-the-a2frobot-for-convergence-studies">
   Using the A2FRobot for convergence studies
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="isotropic-superconductivity">
<h1>Isotropic superconductivity<a class="headerlink" href="#isotropic-superconductivity" title="Permalink to this headline">¶</a></h1>
<div class="jumbotron">
  <h1 class="display-3">Phonon linewidths and Eliashberg function in metals</h1>
  <p class="lead">Aluminium</p> 
  <hr class="my-4">
  <p>
In this lesson, we discuss how to compute the phonon linewidths and the Eliashberg function in metals.
We start with a very brief discussion of the basic equations and some technical details about the Abinit implementation. Then we show how to build an AbiPy flow to automate the multiple steps required 
by these calculations.
</p>
<p>
In the second part, we use the AbiPy objects to analyze the results. We start from the simplest case of a single  calculation whose most important results are stored in the A2F.nc netcdf file. Then we show how to use the A2fRobot to handle multiple netcdf files and perform convergence studies. 
</p>
</div><div class="section" id="a-bit-of-theory-and-some-details-about-the-implementation">
<h2>A bit of theory and some details about the implementation<a class="headerlink" href="#a-bit-of-theory-and-some-details-about-the-implementation" title="Permalink to this headline">¶</a></h2>
<p><span class="math notranslate nohighlight">\(\newcommand{\kk}{{\mathbf k}}\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\qq}{{\mathbf q}}\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\kpq}{{\kk+\qq}}\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\RR}{{\mathbf R}}\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\rr}{{\mathbf r}}\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\&lt;}{\langle}\)</span>
<span class="math notranslate nohighlight">\(\renewcommand{\&gt;}{\rangle}\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\KS}{{\text{KS}}}\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\ww}{\omega}\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\ee}{\epsilon}\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\dd}{{\,\text{d}}}\)</span></p>
<p>The phonon linewidths are proportional to the electron phonon coupling, and depend on the phonon wavevector <span class="math notranslate nohighlight">\(q\)</span>
and the branch index <span class="math notranslate nohighlight">\(\nu\)</span>:</p>
<div class="amsmath math notranslate nohighlight" id="equation-d0c966ac-2ddd-47ff-99bc-8dcf56f15c96">
<span class="eqno">(12)<a class="headerlink" href="#equation-d0c966ac-2ddd-47ff-99bc-8dcf56f15c96" title="Permalink to this equation">¶</a></span>\[\begin{equation}
    \gamma_{\qq\nu} = 2\pi \omega_{\qq\nu} \sum_{mn\kk} |g_{mn\nu}(\kk, \qq)|^2 \delta(\ee_{\kpq m}) \delta(\ee_{\kk n})
\end{equation}\]</div>
<p>Throughout these notes we shall use Hartree atomic units (<span class="math notranslate nohighlight">\(e = \hbar = m_e = 1\)</span>), the Fermi level is set to zero.</p>
<p>The electron-phonon matrix elements are defined by:</p>
<div class="amsmath math notranslate nohighlight" id="equation-dffb9e6f-133e-4c85-8665-103fa0a4548a">
<span class="eqno">(13)<a class="headerlink" href="#equation-dffb9e6f-133e-4c85-8665-103fa0a4548a" title="Permalink to this equation">¶</a></span>\[\begin{equation} %\label{eq:eph_matrix_elements}
    g_{mn}^{\nu}(\kk,\qq) = \dfrac{1}{\sqrt{2\omega_{\qq\nu}}} \&lt;\psi_{m \kpq} | \Delta_{\qq\nu} V^\KS |\psi_{n\kk}\&gt; 
\end{equation}\]</div>
<p>For further details about <span class="math notranslate nohighlight">\(\Delta_{\qq\nu} V^\KS\)</span> and their Fourier interpolation
see the <a class="reference external" href="https://nbviewer.jupyter.org/github/abinit/abitutorials/blob/master/abitutorials/sigeph/lesson_sigeph.ipynb">previous lesson</a>
on the EPH self-energy and <a class="reference external" href="http://dx.doi.org/10.1103/PhysRevB.78.045124">Phys. Rev. B 78, 045124</a>.</p>
<p>The Eliashberg function, <span class="math notranslate nohighlight">\(\alpha^2F(\omega)\)</span>, is similar to the density of states of the phonons, <span class="math notranslate nohighlight">\(F(\omega)\)</span>,
but is weighted according to the coupling of the phonons to the electrons:</p>
<div class="amsmath math notranslate nohighlight" id="equation-70157e8c-7e0a-4939-a842-d29f68246af2">
<span class="eqno">(14)<a class="headerlink" href="#equation-70157e8c-7e0a-4939-a842-d29f68246af2" title="Permalink to this equation">¶</a></span>\[\begin{equation}
    \alpha^2F(\omega) = -\dfrac{1}{N_F} \sum_{\qq\nu} \dfrac{\gamma_{\qq\nu}}{\omega_{\qq\nu}} \delta(\ww - \ww_{\qq \nu})
\end{equation}\]</div>
<!--
From a physical point of view, this function gives the *strenght* by which a phonon of frequency $\omega$
scatters an electronic states on the Fermi surface
For spin unpolarized systems:
-->
<p>The first inverse moment of <span class="math notranslate nohighlight">\(\alpha^2F(\omega)\)</span> gives the total coupling strength,
or mass renormalization factor, <span class="math notranslate nohighlight">\(\lambda\)</span>.</p>
<div class="amsmath math notranslate nohighlight" id="equation-38c61e20-c791-4b38-bf13-9bbdd2399628">
<span class="eqno">(15)<a class="headerlink" href="#equation-38c61e20-c791-4b38-bf13-9bbdd2399628" title="Permalink to this equation">¶</a></span>\[\begin{equation}
    \lambda = \int \dfrac{\alpha^2F(\omega)}{\omega}\dd\omega = \sum_{\qq\nu} \lambda_{\qq\nu}
\end{equation}\]</div>
<div class="amsmath math notranslate nohighlight" id="equation-b0db482c-a214-4d56-9213-a2c5b70490be">
<span class="eqno">(16)<a class="headerlink" href="#equation-b0db482c-a214-4d56-9213-a2c5b70490be" title="Permalink to this equation">¶</a></span>\[\begin{equation}
    \lambda_{\qq\nu} = \dfrac{\gamma_{\qq\nu}}{\pi N_F \ww_{\qq\nu}^2}
\end{equation}\]</div>
<p>From <span class="math notranslate nohighlight">\(\lambda\)</span>, using the <a class="reference external" href="https://doi.org/10.1103/PhysRev.167.331">McMillan formula</a>
as modified by Allen and Dynes in <a class="reference external" href="https://dx.doi.org/10.1103/PhysRevB.12.905">Phys. Rev. B 12 905</a>,
one can estimate the superconducting critical temperature <span class="math notranslate nohighlight">\(T_c\)</span> in the <strong>isotropic</strong> case.</p>
<div class="amsmath math notranslate nohighlight" id="equation-091148a4-c94e-4dbb-b7d5-e0768d88af32">
<span class="eqno">(17)<a class="headerlink" href="#equation-091148a4-c94e-4dbb-b7d5-e0768d88af32" title="Permalink to this equation">¶</a></span>\[\begin{equation}
    T_c = \dfrac{\omega_{log}}{1.2} \exp \Biggl [ 
        \dfrac{-1.04 (1 + \lambda)}{\lambda ( 1 - 0.62 \mu^*) - \mu^*} 
    \Biggr ]
\end{equation}\]</div>
<p>where the logarithmic moment, <span class="math notranslate nohighlight">\(\omega_{log}\)</span>, is defined by:</p>
<div class="amsmath math notranslate nohighlight" id="equation-0b2b85ae-3009-4331-9a0b-0e1ac9bc87ce">
<span class="eqno">(18)<a class="headerlink" href="#equation-0b2b85ae-3009-4331-9a0b-0e1ac9bc87ce" title="Permalink to this equation">¶</a></span>\[\begin{equation}
    \omega_{log} = \exp \Biggl [ 
    \dfrac{2}{\lambda} \int \dfrac{\alpha^2F(\omega)}{\omega}\log(\omega)\dd\omega \Biggr 
    ]
\end{equation}\]</div>
<p>The formula contains the <span class="math notranslate nohighlight">\(\mu^*\)</span> parameter which approximates the effect of the Coulomb interaction.
It is common to treat <span class="math notranslate nohighlight">\(\mu^*\)</span> as an <em>adjustable parameter</em> to reproduce (explain) the experimental <span class="math notranslate nohighlight">\(T_c\)</span>
from the ab-initio computed <span class="math notranslate nohighlight">\(\lambda\)</span>.</p>
<p>It is worth noting that, if we assume constant e-ph matrix elements in the BZ, the phonon linewidths
become proportional to the so-called <em>nesting</em> function defined by:</p>
<div class="amsmath math notranslate nohighlight" id="equation-f6000e5f-fd40-4616-86b6-82099304bda3">
<span class="eqno">(19)<a class="headerlink" href="#equation-f6000e5f-fd40-4616-86b6-82099304bda3" title="Permalink to this equation">¶</a></span>\[\begin{equation}
    N(\qq) = \sum_{mn\kk} \delta(\ee_{\kpq m}) \delta(\ee_{\kk n})
\end{equation}\]</div>
<p>Roughly speaking, there are two factors entering into play in the equation for the phonon linewidths:
the behaviour in (k, q) space of the matrix elements and the <em>geometrical</em> contribution related
to the shape of the Fermi surface (described by the nesting term).</p>
<div class="section" id="implementation-details">
<h3>Implementation details:<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h3>
<p>The input variables <em>optdriver = 7</em> and <em>eph_task = 1</em> activate the computation of:</p>
<div class="amsmath math notranslate nohighlight" id="equation-66fbd0a5-e3c8-429e-bc4e-50468c04b98b">
<span class="eqno">(20)<a class="headerlink" href="#equation-66fbd0a5-e3c8-429e-bc4e-50468c04b98b" title="Permalink to this equation">¶</a></span>\[\begin{equation}
    \gamma_{\qq\nu} = 2\pi \omega_{\qq\nu} \sum_{pp'} d_{\qq p}^* \tilde\gamma_{p p'}(\qq) d_{\qq p'}^*
\end{equation}\]</div>
<p>for all q-points in the IBZ as determined by the <code class="docutils literal notranslate"><span class="pre">ddb_ngqpt</span></code> input variable.
In the above equation, <span class="math notranslate nohighlight">\(p\)</span> is a short-hand notation for atom index and direction,
<span class="math notranslate nohighlight">\(\vec d\)</span> is the phonon displacement and <span class="math notranslate nohighlight">\(\tilde\gamma_{p p'}(\qq)\)</span> is given by:</p>
<div class="amsmath math notranslate nohighlight" id="equation-f6789cb6-a10d-47f3-8a0a-148e1ceed83b">
<span class="eqno">(21)<a class="headerlink" href="#equation-f6789cb6-a10d-47f3-8a0a-148e1ceed83b" title="Permalink to this equation">¶</a></span>\[\begin{equation}
    \tilde\gamma_{p p'}(\qq) = 
    \sum_{mn\kk} g_{mn,p}(\kk, \qq)^*  g_{mn,p'}(\kk, \qq)  \delta(\ee_{\kpq m}) \delta(\ee_{\kk n}).
\end{equation}\]</div>
<p>The <span class="math notranslate nohighlight">\(\tilde\gamma_{p p'}(\qq)\)</span> matrix has the same symmetries as the dynamical matrix
and the elements in the <em>full</em> BZ can be obtained by <em>rotating</em> the initial set of q-points in the IBZ.</p>
<p>Once <span class="math notranslate nohighlight">\(\tilde\gamma(\qq)\)</span> is known in the <em>full</em> BZ, one can Fourier transform to real space with:</p>
<div class="amsmath math notranslate nohighlight" id="equation-ca6e41a3-b8f3-4a45-9f75-5252295320c3">
<span class="eqno">(22)<a class="headerlink" href="#equation-ca6e41a3-b8f3-4a45-9f75-5252295320c3" title="Permalink to this equation">¶</a></span>\[\begin{equation}
    \tilde\gamma_{p p'}(\RR) = \sum_\qq e^{i\qq\cdot\RR} \tilde\gamma_{p p'}(\qq)
\end{equation}\]</div>
<p>and use Fourier interpolation to obtain <span class="math notranslate nohighlight">\(\gamma_{\qq\nu}\)</span> everywhere in the BZ at low cost
(a similar approach is used for the dynamical matrix and phonon frequencies).</p>
<!--
Note that we interpolate the matrices in this representation instead of the phonon mode representation
to avoid numerical instabilities introduce by band crossings.
The code computes $\tilde\gamma$ for all q-points in the IBZ, each matrix is re-symmetrized 
if symdynmat == 1 so that degeneracies at high-symmetry q-points are correctly reproduced.
-->
<p>Thanks to the relatively inexpensive Fourier interpolation, one can obtain the phonon linewidths along
an arbitrary q-path and evaluate the Eliashberg function on a q-mesh (specified by <em>ph_ngqpt</em>)
that can be made <strong>much denser</strong> than the initial ab-initio DDB sampling (specified by <em>ddb_ngqpt</em>) and
even denser than the <code class="docutils literal notranslate"><span class="pre">eph_ngqpt_fine</span></code> q-mesh used to interpolate the DFPT potentials.</p>
<p>Note that the calculation of phonon linewidths in metals is made difficult
by the slow convergence of the double-delta integral over the Fermi surface.
It is therefore convenient to use a coarse k-mesh to calculate phonons with DFPT on a suitable q-grid
and then use a denser k-mesh to perform the integration over the Fermi surface.
The resolution in q-space can be improved by interpolating the DFPT potentials via the
<code class="docutils literal notranslate"><span class="pre">eph_ngqpt_fine</span></code> input variable as discussed in the <a class="reference external" href="https://nbviewer.jupyter.org/github/abinit/abitutorials/blob/master/abitutorials/sigeph/lesson_sigeph.ipynb">previous EPH lesson</a>.</p>
</div>
</div>
<div class="section" id="suggested-references">
<h2>Suggested references<a class="headerlink" href="#suggested-references" title="Permalink to this headline">¶</a></h2>
<p>The general theory of electron-phonon coupling and Eliashberg superconductivity is reviewed
by P.B. Allen and B. Mitrovic
in <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0081194708606657">Theory of Superconducting Tc</a>.
The first implementations similar to that in Abinit are those in
<a class="reference external" href="https://doi.org/10.1103/PhysRevB.54.16487">Savrasov</a> and
<a class="reference external" href="https://doi.org/10.1103/PhysRevB.53.R7575">Liu</a>.</p>
</div>
<div class="section" id="technical-details">
<h2>Technical details<a class="headerlink" href="#technical-details" title="Permalink to this headline">¶</a></h2>
<p>From the previous discussion, it should be clear that a typical calculation of phonon linewidths requires:</p>
<ol class="simple">
<li><p>An initial set of KS wavefunctions and eigenvalues.</p></li>
<li><p>The knowledge of the dynamical matrix <span class="math notranslate nohighlight">\(D(\qq)\)</span> from which one
can obtain frequencies and displacements everywhere in the BZ via Fourier interpolation.</p></li>
<li><p>A set of DFPT potentials given in the IBZ</p></li>
</ol>
<p>Thanks to these three ingredients, the code can compute the EPH matrix elements
and perform the integration over the Fermi surface.
A schematic representation of a typical workflow with Abinit is given in the figure below:</p>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/abinit/abipy_assets/master/eph_workflow.png"><img alt="https://raw.githubusercontent.com/abinit/abipy_assets/master/eph_workflow.png" src="https://raw.githubusercontent.com/abinit/abipy_assets/master/eph_workflow.png" style="width: 600px; height: 600px;" /></a>
<p>The <code class="docutils literal notranslate"><span class="pre">mrgddb</span></code> and <code class="docutils literal notranslate"><span class="pre">mrgdv</span></code> are Fortran executables whose main goal is to produce the final files
required in the EPH code.</p>
<p>Note, in particular, how the computation of the WFK file and the DFPT part of the graph are now decoupled.
This is the approach we are going to implement with AbiPy to converge the phonon linewidths in Al:</p>
<ol class="simple">
<li><p>Compute DFPT phonons on a 4x4x4 q-mesh with a coarse 8x8x8 k-sampling</p></li>
<li><p>Generate 3 WFK files on a much denser k-mesh (x16, x24, x32)</p></li>
<li><p>Run the EPH code with</p></li>
</ol>
<ul class="simple">
<li><p>one of the WFK files generated in point 2.</p></li>
<li><p>interpolated DFPT potentials (from the initial 4x4x4 to a 8x8x8 q-mesh)</p></li>
</ul>
<ol class="simple">
<li><p>Compute the Eliashberg function on the <code class="docutils literal notranslate"><span class="pre">ph_ngqpt</span></code> mesh via Fourier interpolation.</p></li>
<li><p>Analyze the convergence of the results wrt <code class="docutils literal notranslate"><span class="pre">nkpt</span></code>.</p></li>
</ol>
</div>
<div class="section" id="building-the-flow">
<h2>Building the Flow<a class="headerlink" href="#building-the-flow" title="Permalink to this headline">¶</a></h2>
<p>Before starting, we need to import the python modules used in this notebook:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use this at the beginning of your script so that your code will be compatible with python3</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span> <span class="c1"># to get rid of deprecation warnings</span>

<span class="kn">from</span> <span class="nn">abipy</span> <span class="kn">import</span> <span class="n">abilab</span>
<span class="n">abilab</span><span class="o">.</span><span class="n">enable_notebook</span><span class="p">()</span> <span class="c1"># This line tells AbiPy we are running inside a notebook</span>
<span class="kn">import</span> <span class="nn">abipy.flowtk</span> <span class="k">as</span> <span class="nn">flowtk</span>

<span class="c1"># This line configures matplotlib to show figures embedded in the notebook.</span>
<span class="c1"># Replace `inline` with `notebook` in classic notebook</span>
<span class="o">%</span><span class="k">matplotlib</span> inline   

<span class="c1"># Option available in jupyterlab. See https://github.com/matplotlib/jupyter-matplotlib</span>
<span class="c1">#%matplotlib widget </span>
</pre></div>
</div>
</div>
</div>
<p>and a function from the <code class="docutils literal notranslate"><span class="pre">lesson_eph_al</span></code> module to build our AbiPy flow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lesson_eph_al</span> <span class="kn">import</span> <span class="n">build_flow</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-info" role="alert">
Please read the code carefully, in particular the comments.
Don't worry if the meaning of some input variables is not immediately clear
as we will try to clarify the most technical parts in the rest of this notebook.
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">abilab</span><span class="o">.</span><span class="n">print_source</span><span class="p">(</span><span class="n">build_flow</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2021 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=None">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2021 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888888 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_flow</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build and return an AbiPy flow to compute phonon linewidths and Eliashberg function in Aluminium:</span>

<span class="sd">        1. Compute DFPT phonons on a 4x4x4 q-mesh with a coarse 8x8x8 k-sampling</span>

<span class="sd">        2. Generate 3 WFK files on a much denser k-mesh (x16, x24, x32)</span>

<span class="sd">        3. Run the EPH code with:</span>

<span class="sd">          - one of the WFK files generated in point 2.</span>
<span class="sd">          - interpolated DFPT potentials (from the initial 4x4x4 to a 8x8x8 q-mesh)</span>

<span class="sd">        4. Analyze the convergence of the results wrt nkpt.</span>

<span class="sd">    Note that the q-point grid must be a sub-grid of the k-point grid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workdir</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">workdir</span> <span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;flow_eph_al&quot;</span>

    <span class="c1"># Create empty flow.</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">flowtk</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">)</span>

    <span class="c1"># Init structure. Use NC pseudo</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">abilab</span><span class="o">.</span><span class="n">Structure</span><span class="o">.</span><span class="n">fcc</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Al&quot;</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;bohr&quot;</span><span class="p">)</span>
    <span class="n">pseudos</span> <span class="o">=</span> <span class="n">abidata</span><span class="o">.</span><span class="n">pseudos</span><span class="p">(</span><span class="s2">&quot;Al.oncvpsp&quot;</span><span class="p">)</span>

    <span class="c1"># Input for GS part.</span>
    <span class="n">gs_inp</span> <span class="o">=</span> <span class="n">abilab</span><span class="o">.</span><span class="n">AbinitInput</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">)</span>
    <span class="n">gs_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span>
        <span class="n">istwfk</span><span class="o">=</span><span class="s2">&quot;*1&quot;</span><span class="p">,</span>
        <span class="n">ecut</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span>
        <span class="n">nband</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">occopt</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>      <span class="c1"># Include metallic occupation function with a small smearing</span>
        <span class="n">tsmear</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
        <span class="n">tolvrs</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># The k-grid is minimalistic to keep the calculation manageable.</span>
    <span class="n">gs_inp</span><span class="o">.</span><span class="n">set_kmesh</span><span class="p">(</span>
        <span class="n">ngkpt</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
        <span class="n">shiftk</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Build new input for NSCF calculation along k-path (automatically selected by AbiPy)</span>
    <span class="c1"># Used to plot the KS band structure.</span>
    <span class="n">nscf_kpath_inp</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">new_with_vars</span><span class="p">(</span>
        <span class="n">nband</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">tolwfr</span><span class="o">=</span><span class="mf">1e-16</span><span class="p">,</span>
        <span class="n">iscf</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">nscf_kpath_inp</span><span class="o">.</span><span class="n">set_kpath</span><span class="p">(</span><span class="n">ndivsm</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Build NSCF inputs with denser k-meshes</span>
    <span class="c1"># This step generates the WFK files used to compute the Eliashberg function.</span>
    <span class="c1"># We have a cubic material so we only need to specify the first number of divisions.</span>
    <span class="n">nk_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">]</span>

    <span class="n">nscf_kmesh_inputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nk</span> <span class="ow">in</span> <span class="n">nk_list</span><span class="p">:</span>
        <span class="n">new_inp</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">new_with_vars</span><span class="p">(</span>
            <span class="n">tolwfr</span><span class="o">=</span><span class="mf">1e-16</span><span class="p">,</span>
            <span class="n">iscf</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">ngkpt</span><span class="o">=</span><span class="p">[</span><span class="n">nk</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">shiftk</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">nscf_kmesh_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_inp</span><span class="p">)</span>

    <span class="c1"># Register GS + NSCF kpath + NSCF with k-meshes in work0.</span>
    <span class="n">work0</span> <span class="o">=</span> <span class="n">flowtk</span><span class="o">.</span><span class="n">BandStructureWork</span><span class="p">(</span><span class="n">gs_inp</span><span class="p">,</span> <span class="n">nscf_kpath_inp</span><span class="p">,</span> <span class="n">dos_inputs</span><span class="o">=</span><span class="n">nscf_kmesh_inputs</span><span class="p">)</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work0</span><span class="p">)</span>

    <span class="c1"># Generate Phonon work with 4x4x4 q-mesh</span>
    <span class="c1"># Reuse the variables from GS input and let AbiPy handle the generation of the input files</span>
    <span class="c1"># Note that the q-point grid is a sub-grid of the k-mesh so we do not need WFQ on k+q mesh.</span>
    <span class="n">ddb_ngqpt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">ph_work</span> <span class="o">=</span> <span class="n">flowtk</span><span class="o">.</span><span class="n">PhononWork</span><span class="o">.</span><span class="n">from_scf_task</span><span class="p">(</span><span class="n">work0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ddb_ngqpt</span><span class="p">,</span> <span class="n">is_ngqpt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">ph_work</span><span class="p">)</span>

    <span class="c1"># Ssction for EPH calculation: compute linewidths with different WFK files.</span>
    <span class="n">eph_work</span> <span class="o">=</span> <span class="n">flowtk</span><span class="o">.</span><span class="n">Work</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">nk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nk_list</span><span class="p">):</span>
        <span class="c1"># Each task uses a different WFK file. DDB and DBDB do not change.</span>
        <span class="n">eph_deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">work0</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ik</span><span class="p">]:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="n">ph_work</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DDB&quot;</span><span class="p">,</span> <span class="s2">&quot;DVDB&quot;</span><span class="p">]}</span>

        <span class="c1"># Interpolate DFPT potentials 4x4x4 --&gt; 8x8x8</span>
        <span class="n">eph_ngqpt_fine</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

        <span class="c1"># Build input for E-PH run. See also v7/Input/t85.in</span>
        <span class="c1"># The k-points must be in the WFK file</span>
        <span class="n">eph_inp</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">new_with_vars</span><span class="p">(</span>
            <span class="n">optdriver</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>                    <span class="c1"># Enter EPH driver.</span>
            <span class="n">eph_task</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>                     <span class="c1"># Compute phonon linewidths in metals.</span>
            <span class="n">ddb_ngqpt</span><span class="o">=</span><span class="n">ddb_ngqpt</span><span class="p">,</span>            <span class="c1"># q-mesh used to produce the DDB file (must be consistent with DDB data)</span>
            <span class="n">eph_fsewin</span><span class="o">=</span><span class="s2">&quot;0.8 eV&quot;</span><span class="p">,</span>            <span class="c1"># Energy window around Ef (only states in this window are included)</span>
            <span class="n">eph_intmeth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>                  <span class="c1"># Tetra method</span>
            <span class="c1">#eph_intmeth=1,                 # Gaussian</span>
            <span class="c1">#eph_fsmear=eph_fsmear * abilab.units.eV_to_Ha, # Broadening</span>
            <span class="n">eph_ngqpt_fine</span><span class="o">=</span><span class="n">eph_ngqpt_fine</span><span class="p">,</span>  <span class="c1"># Interpolate DFPT potentials if != ddb_ngqpt</span>
            <span class="n">eph_mustar</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span>                <span class="c1"># mustar parameter</span>
            <span class="n">ngkpt</span><span class="o">=</span><span class="p">[</span><span class="n">nk</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">shiftk</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Set q-path to interpolate phonons and phonon linewidths.</span>
        <span class="n">eph_inp</span><span class="o">.</span><span class="n">set_qpath</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Set q-mesh for phonons DOS and a2F(w)</span>
        <span class="n">eph_inp</span><span class="o">.</span><span class="n">set_phdos_qmesh</span><span class="p">(</span><span class="n">nqsmall</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;tetra&quot;</span><span class="p">)</span>
        <span class="n">eph_work</span><span class="o">.</span><span class="n">register_eph_task</span><span class="p">(</span><span class="n">eph_inp</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">eph_deps</span><span class="p">)</span>

    <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">eph_work</span><span class="p">)</span>

    <span class="c1"># Avoid producing (big) output files that not required by children.</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">use_smartio</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">flow</span>
</pre></div>
</body>
</html>
</div></div>
</div>
<p>OK the function is a little bit long but it is normal as we are computing
in a single workflow the <em>electronic</em> properties, the <em>vibrational</em> spectrum
and the <em>phonon linewidths</em> with different k-point samplings.</p>
<p>Note that we have already encountered similar flows in the previous AbiPy lessons.
The calculation of electronic band structures is
discussed in
<a class="reference external" href="https://nbviewer.jupyter.org/github/abinit/abitutorials/blob/master/abitutorials/base3/lesson_base3.ipynb">lesson_base3</a>
while an example of <code class="docutils literal notranslate"><span class="pre">Flow</span></code> for phonon calculations is given in
<a class="reference external" href="https://nbviewer.jupyter.org/github/abinit/abitutorials/blob/master/abitutorials/dfpt/lesson_dfpt.ipynb">lesson_dfpt</a>.</p>
<p>The novelty is represented by the generation of the <code class="docutils literal notranslate"><span class="pre">EphTasks</span></code>
in which we have to specify several variables related to phonons and the EPH self-energy.
For your convenience, we have grouped the variables used in the <code class="docutils literal notranslate"><span class="pre">EphTask</span></code> in sub-groups:</p>
<img alt="https://github.com/abinit/abipy_assets/blob/master/eph_variables.png?raw=true" src="https://github.com/abinit/abipy_assets/blob/master/eph_variables.png?raw=true" />
<p>Hopefully things will become clearer if we build the flow and start to play with it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flow</span> <span class="o">=</span> <span class="n">build_flow</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">flow</span><span class="o">.</span><span class="n">show_info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Flow, node_id=442368, workdir=flow_eph_al&gt;
Number of works: 3, total number of tasks: 22
Number of tasks with a given class:

Task Class      Number
------------  --------
ScfTask              1
NscfTask             4
PhononTask          14
EphTask              3
</pre></div>
</div>
</div>
</div>
<p>We then print the input of the last <code class="docutils literal notranslate"><span class="pre">EphTask</span></code>.
Please read carefully the documentation of the variables, in particular
those in the <code class="docutils literal notranslate"><span class="pre">dfpt</span></code> and <code class="docutils literal notranslate"><span class="pre">eph</span></code> sections.</p>
<p>In a nutshell: we read a WKF on a 32x32x32 k-mesh and a DDB on a 4x4x4 q-mesh,
activate the computation of phonon linewidths with <code class="docutils literal notranslate"><span class="pre">optdriver</span></code> and <code class="docutils literal notranslate"><span class="pre">eph_task</span></code>,
interpolate the potentials onto a 8x8x8 q-mesh with <code class="docutils literal notranslate"><span class="pre">eph_ngqpt_fine</span></code> and set other variables
for the computation of the phonon linewidths around the Fermi surface.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">flow</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">input</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;EphTask, node_id=442402, workdir=flow_eph_al/w2/t2&gt;
</pre></div>
</div>
<div class="output text_html"><div class="abinit_input">
##############################################<br>####                SECTION: basic               <br>##############################################<br> <a href="https://docs.abinit.org/variables/basic#ecut" target="_blank">ecut</a> 8.0<br> <a href="https://docs.abinit.org/variables/basic#nband" target="_blank">nband</a> 4<br> <a href="https://docs.abinit.org/variables/basic#occopt" target="_blank">occopt</a> 7<br> <a href="https://docs.abinit.org/variables/basic#tolvrs" target="_blank">tolvrs</a> 1e-07<br> <a href="https://docs.abinit.org/variables/basic#ngkpt" target="_blank">ngkpt</a> 32 32 32<br> <a href="https://docs.abinit.org/variables/basic#kptopt" target="_blank">kptopt</a> 1<br> <a href="https://docs.abinit.org/variables/basic#nshiftk" target="_blank">nshiftk</a> 1<br> <a href="https://docs.abinit.org/variables/basic#shiftk" target="_blank">shiftk</a>    0.0    0.0    0.0<br>##############################################<br>####                 SECTION: dev                <br>##############################################<br> <a href="https://docs.abinit.org/variables/dev#istwfk" target="_blank">istwfk</a> *1<br>##############################################<br>####                 SECTION: eph                <br>##############################################<br> <a href="https://docs.abinit.org/variables/eph#eph_task" target="_blank">eph_task</a> 1<br> <a href="https://docs.abinit.org/variables/eph#ddb_ngqpt" target="_blank">ddb_ngqpt</a> 4 4 4<br> <a href="https://docs.abinit.org/variables/eph#eph_fsewin" target="_blank">eph_fsewin</a> 0.8 eV<br> <a href="https://docs.abinit.org/variables/eph#eph_intmeth" target="_blank">eph_intmeth</a> 2<br> <a href="https://docs.abinit.org/variables/eph#eph_ngqpt_fine" target="_blank">eph_ngqpt_fine</a> 8 8 8<br> <a href="https://docs.abinit.org/variables/eph#eph_mustar" target="_blank">eph_mustar</a> 0.12<br> <a href="https://docs.abinit.org/variables/eph#ph_ndivsm" target="_blank">ph_ndivsm</a> 10<br> <a href="https://docs.abinit.org/variables/eph#ph_nqpath" target="_blank">ph_nqpath</a> 12<br> <a href="https://docs.abinit.org/variables/eph#ph_qpath" target="_blank">ph_qpath</a><br>    0.0    0.0    0.0<br>    0.5    0.0    0.5<br>    0.5    0.25    0.75<br>    0.375    0.375    0.75<br>    0.0    0.0    0.0<br>    0.5    0.5    0.5<br>    0.625    0.25    0.625<br>    0.5    0.25    0.75<br>    0.5    0.5    0.5<br>    0.375    0.375    0.75<br>    0.625    0.25    0.625<br>    0.5    0.0    0.5<br> <a href="https://docs.abinit.org/variables/eph#ph_intmeth" target="_blank">ph_intmeth</a> 2<br> <a href="https://docs.abinit.org/variables/eph#ph_wstep" target="_blank">ph_wstep</a> 0.0001 eV<br> <a href="https://docs.abinit.org/variables/eph#ph_ngqpt" target="_blank">ph_ngqpt</a> 24 24 24<br> <a href="https://docs.abinit.org/variables/eph#ph_qshift" target="_blank">ph_qshift</a> 0 0 0<br> <a href="https://docs.abinit.org/variables/eph#ph_nqshift" target="_blank">ph_nqshift</a> 1<br>##############################################<br>####                SECTION: files               <br>##############################################<br> <a href="https://docs.abinit.org/variables/files#prtwf" target="_blank">prtwf</a> -1<br> <a href="https://docs.abinit.org/variables/files#prtden" target="_blank">prtden</a> 0<br>##############################################<br>####               SECTION: gstate               <br>##############################################<br> <a href="https://docs.abinit.org/variables/gstate#tsmear" target="_blank">tsmear</a> 0.04<br> <a href="https://docs.abinit.org/variables/gstate#optdriver" target="_blank">optdriver</a> 7<br>##############################################<br>####                  STRUCTURE                  <br>##############################################<br> <a href="https://docs.abinit.org/variables/basic#natom" target="_blank">natom</a> 1<br> <a href="https://docs.abinit.org/variables/basic#ntypat" target="_blank">ntypat</a> 1<br> <a href="https://docs.abinit.org/variables/basic#typat" target="_blank">typat</a> 1<br> <a href="https://docs.abinit.org/variables/basic#znucl" target="_blank">znucl</a> 13<br> <a href="https://docs.abinit.org/variables/basic#xred" target="_blank">xred</a>    0.0000000000    0.0000000000    0.0000000000<br> <a href="https://docs.abinit.org/variables/basic#acell" target="_blank">acell</a>    1.0    1.0    1.0<br> <a href="https://docs.abinit.org/variables/basic#rprim" target="_blank">rprim</a><br>    0.0000000000    3.7500000000    3.7500000000<br>    3.7500000000    0.0000000000    3.7500000000<br>    3.7500000000    3.7500000000    0.0000000000
<div></div></div>
</div>
<div class="alert alert-info" role="alert">
The input does not contain any `irdwfk` or `getwfk` variable. AbiPy will add the required `ird*` 
variables at runtime and create symbolic links to connect this task to its parents.
</div><p>As usual, it is much easier to understand what is happening if we plot a graph
with the individual tasks and their connections.
Since there are several nodes in our graph, we mainly focus on the EPH part.</p>
<p>Let’s have a look at the parents of the last <code class="docutils literal notranslate"><span class="pre">EphTask</span></code> with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flow</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_graphviz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_15_0.svg" src="../_images/lesson_eph_al_15_0.svg" /></div>
</div>
<p>We do not repeat here the detailed description of the Flow because it is very similar in spirit
to what has been already done in the <a class="reference external" href="https://nbviewer.jupyter.org/github/abinit/abitutorials/blob/master/abitutorials/sigeph/lesson_sigeph.ipynb">previous EPH lesson</a>.
Hopefully, you are already familiar with the AbiPy philosophy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ngkpt in EPH tasks:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s2">&quot;ngkpt&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">flow</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ngkpt in EPH tasks: [[16, 16, 16], [24, 24, 24], [32, 32, 32]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flow</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_vars_dataframe</span><span class="p">(</span><span class="s2">&quot;ngkpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ngkpt</th>
      <th>class</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>w2_t0</th>
      <td>[16, 16, 16]</td>
      <td>EphTask</td>
    </tr>
    <tr>
      <th>w2_t1</th>
      <td>[24, 24, 24]</td>
      <td>EphTask</td>
    </tr>
    <tr>
      <th>w2_t2</th>
      <td>[32, 32, 32]</td>
      <td>EphTask</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>For completeness, we show the entire flow with the different connections:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flow</span><span class="o">.</span><span class="n">get_graphviz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_20_0.svg" src="../_images/lesson_eph_al_20_0.svg" /></div>
</div>
<div class="alert alert-info" role="alert">
You may wonder why we have so many tasks especially if you are used to the multi-dataset philosophy of Abinit.
Indeed if you are a `ndtset` master, it should not be so difficult for you
to write a *single input file* that performs the same kind of convergence study.
Still you have to consider that the multi-dataset approach does not scale well: 
this kind of calculation has several independent steps 
that could be executed in parallel whereas abinit datasets are executed sequentially. 
This makes a huge difference when running on clusters with hundreds or thousands of CPUs because 
the *time to solution* can be considerably reduced with this kind of parallelism.
</div>
<!-- Note that the q-mesh for the self-energy is denser than the *ab-initio* one used for the DFPT run.
This means that the code will activate the Fourier interpolation of the DFPT potentials.
Note that the k-mesh and the q-mesh cannot be arbitrary. 

<div class="alert alert-info" role="alert">
Remember that the $k$-point mesh cannot be chosen arbitrarily
since all $k$ wavevectors should connect two $k$ points of the grid used for the electrons.

More specifically, the q-mesh associated to the 
`DDB` (`DVDB`) must be a submesh of the k-mesh for electrons.
Moreover the EPH code can compute self-energy corrections only for the states that are available in the `WFK` file.
</div>
--><p>Now we can generate the directories and the input files of the <code class="docutils literal notranslate"><span class="pre">Flow</span></code> with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>flow.build_and_pickle_dump()
</pre></div>
</div>
<p>and then use the <code class="docutils literal notranslate"><span class="pre">abirun.py</span></code> script to launch the entire calculation:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>abirun.py flow_eph_al scheduler
</pre></div>
</div>
<p>You may want to run this example in the terminal if you’ve already installed and configured AbiPy and Abinit on your machine. The calculation requires ~12 minutes on a poor 1.7 GHz Intel Core i5 (50% of the time
is spent in the last task to compute the phonon linewidths with the 32x32x32 k-mesh)</p>
<p>If you prefer to skip this part, jump to next section in which we focus on the post-processing of the results.
Note that most of the output files are already available in the <a class="reference external" href="https://github.com/abinit/abitutorials">github repository</a>
so it is possible to try the AbiPy post-processing tools without having to run the flow.
Some DVDB, DDB, PHDOS, and PBSTS files are missing, but their absence will not prevent running the present tutorial to the end.
In particular, one can use the command line and the commands:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>abiopen.py FILE
</pre></div>
</div>
<p>to open the file inside ipython,</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>abiopen.py ut_A2F.nc --expose
</pre></div>
</div>
<p>to visualize the EPH results and finally,</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>abicomp.py a2f flow_ep_al/
</pre></div>
</div>
<p>to compare multiple <code class="docutils literal notranslate"><span class="pre">A2F.nc</span></code> files with the robot and ipython.</p>
</div>
<div class="section" id="electronic-properties">
<h2>Electronic properties<a class="headerlink" href="#electronic-properties" title="Permalink to this headline">¶</a></h2>
<p>Let’s focus on the electronic properties first.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>find flow_eph_al/ -name <span class="s2">&quot;out_GSR.nc&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>flow_eph_al//w0/t2/outdata/out_GSR.nc
flow_eph_al//w0/t3/outdata/out_GSR.nc
flow_eph_al//w0/t4/outdata/out_GSR.nc
flow_eph_al//w0/t1/outdata/out_GSR.nc
flow_eph_al//w0/t0/outdata/out_GSR.nc
</pre></div>
</div>
</div>
</div>
<p>The task <code class="docutils literal notranslate"><span class="pre">w0/t0</span></code> computed the electronic band structure on a high-symmetry k-path.
Let’s plot the bands with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">abilab</span><span class="o">.</span><span class="n">abiopen</span><span class="p">(</span><span class="s2">&quot;flow_eph_al/w0/t1/outdata/out_GSR.nc&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">gsr</span><span class="p">:</span>
    <span class="n">ebands_kpath</span> <span class="o">=</span> <span class="n">gsr</span><span class="o">.</span><span class="n">ebands</span>
    
<span class="c1"># NB: Fermi level set to zero</span>
<span class="n">ebands_kpath</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_26_0.png" src="../_images/lesson_eph_al_26_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#print(ebands_kpath)</span>
</pre></div>
</div>
</div>
</div>
<p>To better understand what’s happening at <span class="math notranslate nohighlight">\(\ee_F\)</span>, we can plot the bandwidths with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ebands_kpath</span><span class="o">.</span><span class="n">boxplot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_29_0.png" src="../_images/lesson_eph_al_29_0.png" />
</div>
</div>
<p>There is only one band <strong>index</strong> crossing the Fermi level if we exclude a tiny portion with band index 2 (see the region close to the W point).
As phonon lifetimes are very sensitive to the Fermi surface sampling,
it is a good idea to analyze the convergence of the electronic DOS,
in particular the behavior in the region around <span class="math notranslate nohighlight">\(\ee_F\)</span>.</p>
<p>Let’s use the <code class="docutils literal notranslate"><span class="pre">GsrRobot</span></code> to load all the <code class="docutils literal notranslate"><span class="pre">GSR</span></code> files produced by the <code class="docutils literal notranslate"><span class="pre">w0</span></code> work:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gsr_robot</span> <span class="o">=</span> <span class="n">abilab</span><span class="o">.</span><span class="n">GsrRobot</span><span class="o">.</span><span class="n">from_dir_glob</span><span class="p">(</span><span class="s2">&quot;flow_eph_al/w0/t*/&quot;</span><span class="p">)</span>
<span class="n">gsr_robot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><ol start="0">
<li>flow_eph_al/w0/t2/outdata/out_GSR.nc</li>
<li>flow_eph_al/w0/t3/outdata/out_GSR.nc</li>
<li>flow_eph_al/w0/t4/outdata/out_GSR.nc</li>
<li>flow_eph_al/w0/t1/outdata/out_GSR.nc</li>
<li>flow_eph_al/w0/t0/outdata/out_GSR.nc</li>
</ol></div></div>
</div>
<p>In total, we have 5 <code class="docutils literal notranslate"><span class="pre">GSR</span></code> files but <code class="docutils literal notranslate"><span class="pre">w0/t1</span></code> computed the energies along the k-path and the
DOS <strong>requires</strong> a homogeneous sampling.
Let’s remove the file for which this is not the case from the robot with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gsr_robot</span><span class="o">.</span><span class="n">pop_label</span><span class="p">(</span><span class="s2">&quot;flow_eph_al/w0/t1/outdata/out_GSR.nc&quot;</span><span class="p">)</span>
<span class="n">gsr_robot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><ol start="0">
<li>flow_eph_al/w0/t2/outdata/out_GSR.nc</li>
<li>flow_eph_al/w0/t3/outdata/out_GSR.nc</li>
<li>flow_eph_al/w0/t4/outdata/out_GSR.nc</li>
<li>flow_eph_al/w0/t0/outdata/out_GSR.nc</li>
</ol></div></div>
</div>
<p>and use a small lambda function to change the labels associated to the files
so that we have the number of k-points in the IBZ:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gsr_robot</span><span class="o">.</span><span class="n">remap_labels</span><span class="p">(</span><span class="k">lambda</span> <span class="n">gsr</span><span class="p">:</span> <span class="s2">&quot;nkpt: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gsr</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OrderedDict([(&#39;nkpt: 145&#39;, &#39;flow_eph_al/w0/t2/outdata/out_GSR.nc&#39;),
             (&#39;nkpt: 413&#39;, &#39;flow_eph_al/w0/t3/outdata/out_GSR.nc&#39;),
             (&#39;nkpt: 897&#39;, &#39;flow_eph_al/w0/t4/outdata/out_GSR.nc&#39;),
             (&#39;nkpt: 29&#39;, &#39;flow_eph_al/w0/t0/outdata/out_GSR.nc&#39;)])
</pre></div>
</div>
</div>
</div>
<p>Now we can finally compare the electronic DOS obtained with the different k-meshes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gsr_robot</span><span class="o">.</span><span class="n">combiplot_edos</span><span class="p">(</span><span class="n">xlims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="o">+</span><span class="mi">5</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_37_0.png" src="../_images/lesson_eph_al_37_0.png" />
</div>
</div>
<p>Clearly, the 8x8x8 k-mesh used to compute the density is not enough to converge the DOS at <span class="math notranslate nohighlight">\(\ee_F\)</span>.
Remember, however, that we have decided to use a minimalistic sampling in the GS/DFPT run
to keep the calculation manageable.
In real life, one should use a much denser k-sampling for the GS/DFPT and this is particularly
true if we are trying to relax the structure.
Let’s forget about this technical point and focus on the DOS obtained with the other two k-meshes.</p>
<p>As you can see, even if 145 k-points in the IBZ are not enough, the DOS is becoming <em>smoother</em>
and starts to resemble the one of the free-electron gas (as a matter of fact the band dispersion of Al is not
that different from the ideal free-electron model provided that BZ folding is taken into account).</p>
<p>Visual inspection suggests that the k-sampling becomes <em>acceptable</em> at and beyond 24x24x24 (413 nkpt).</p>
<div class="alert alert-info" role="alert">
The convergence of the DOS at the Fermi level does not necessarly imply convergence in the final EPH results. 
This is something that should be checked explicitly by looking at the behaviour of the final observables
as a function of the input parameters.
</div><p>In the introduction, we mentioned that there are two factors governing the strengh of the E-PH coupling in metals:
the behaviour in (k, q)-space of the matrix elements and the <em>geometrical</em> contribution due to the Fermi surface.</p>
<div class="amsmath math notranslate nohighlight" id="equation-844625cb-f199-4902-81cf-47acf7c93358">
<span class="eqno">(23)<a class="headerlink" href="#equation-844625cb-f199-4902-81cf-47acf7c93358" title="Permalink to this equation">¶</a></span>\[\begin{equation}
    N(\qq) = \sum_{mn\kk} \delta(\ee_{\kpq m}) \delta(\ee_{\kk n})
\end{equation}\]</div>
<p>To understand the <em>geometrical</em> contribution, it is useful to visualize the Fermi surface.
Unfortunately, graphical applications usually require KS eigenvalues on a
<span class="math notranslate nohighlight">\(\Gamma-\)</span>centered k-mesh in the <em>full</em> BZ whereas ab-initio codes usually work with KS states
in the <em>irreducible</em> wedge.</p>
<p>Fortunately, we can use AbiPy to reconstruct the KS eigenvalues in the full BZ:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select the last GSR file in thr robot.</span>
<span class="n">eb3d</span> <span class="o">=</span> <span class="n">gsr_robot</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_ebands3d</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>and then use matplotlib to visualize the Fermi energy isosurfaces:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eb3d</span><span class="o">.</span><span class="n">plot_isosurfaces</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_42_0.png" src="../_images/lesson_eph_al_42_0.png" />
</div>
</div>
<p>Note that, at present, the matplotlib version is only able to display isosurfaces
in the unit cell of the reciprocal lattice.
To visualize isosurfaces in the first BZ, one can export the data
into BXSF format and then call <a class="reference external" href="http://www.xcrysden.org/">xcrysden</a> with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#eb3d.xcrysden_view()</span>
</pre></div>
</div>
</div>
</div>
<p>This is the image you should get with xcrysden:</p>
<a class="reference internal image-reference" href="https://github.com/abinit/abipy_assets/blob/master/alfs_xcrysden.png?raw=true"><img alt="https://github.com/abinit/abipy_assets/blob/master/alfs_xcrysden.png?raw=true" src="https://github.com/abinit/abipy_assets/blob/master/alfs_xcrysden.png?raw=true" style="width: 600px; height: 600px;" /></a>
</div>
<div class="section" id="vibrational-properties">
<h2>Vibrational properties<a class="headerlink" href="#vibrational-properties" title="Permalink to this headline">¶</a></h2>
<p>Now we turn our attention to the vibrational properties.
AbiPy has already merged all the independent atomic perturbations in <code class="docutils literal notranslate"><span class="pre">flow_eph_al/w1/outdata/out_DDB</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>find flow_eph_al/ -name <span class="s2">&quot;out_DDB&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>flow_eph_al//w1/outdata/out_DDB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>cat flow_eph_al/w1/outdata/mrgddb.stdin
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/outdata/out_DDB
DDB file merged by PhononWork on Sun Mar 18 14:41:09 2018
14
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t0/outdata/out_DDB
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t1/outdata/out_DDB
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t2/outdata/out_DDB
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t3/outdata/out_DDB
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t4/outdata/out_DDB
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t5/outdata/out_DDB
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t6/outdata/out_DDB
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t7/outdata/out_DDB
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t8/outdata/out_DDB
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t9/outdata/out_DDB
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t10/outdata/out_DDB
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t11/outdata/out_DDB
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t12/outdata/out_DDB
/Users/gmatteo/git_repos/abitutorials/abitutorials/eph_al/flow_eph_al/w1/t13/outdata/out_DDB
</pre></div>
</div>
</div>
</div>
<p>In the same directory, we have the <code class="docutils literal notranslate"><span class="pre">DVDB</span></code> file containing the independent DFPT potentials</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>find flow_eph_al/ -name <span class="s2">&quot;out_DVDB&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!cat flow_eph_al//w1/outdata/mrgdvdb.stdin</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s open the <code class="docutils literal notranslate"><span class="pre">DDB</span></code> file computed on the 4x4x4 q-mesh with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ddb</span> <span class="o">=</span> <span class="n">abilab</span><span class="o">.</span><span class="n">abiopen</span><span class="p">(</span><span class="s2">&quot;flow_eph_al/w1/outdata/out_DDB&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ddb</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>================================= File Info =================================
Name: out_DDB
Directory: /Users/gmatteo/git_repos/abipy_book/abipy_book/eph_al/flow_eph_al/w1/outdata
Size: 42.10 kb
Access Time: Thu Jul  8 02:48:30 2021
Modification Time: Thu Jul  8 02:05:05 2021
Change Time: Thu Jul  8 02:05:05 2021

================================= Structure =================================
Full Formula (Al1)
Reduced Formula: Al
abc   :   2.806386   2.806386   2.806386
angles:  60.000000  60.000000  60.000000
Sites (1)
  #  SP      a    b    c
---  ----  ---  ---  ---
  0  Al      0    0    0

Abinit Spacegroup: spgid: 0, num_spatial_symmetries: 48, has_timerev: True, symmorphic: False

================================== DDB Info ==================================

Number of q-points in DDB: 8
guessed_ngqpt: [4 4 4] (guess for the q-mesh divisions made by AbiPy)
ecut = 8.000000, ecutsm = 0.000000, nkpt = 260, nsym = 48, usepaw = 0
nsppol 1, nspinor 1, nspden 1, ixc = 11, occopt = 7, tsmear = 0.040000

Has total energy: False, Has forces: False
Has stress tensor: False

Has (at least one) atomic pertubation: True
Has (at least one diagonal) electric-field perturbation: False
Has (at least one) Born effective charge: False
Has (all) strain terms: False
Has (all) internal strain terms: False
Has (all) piezoelectric terms: False
</pre></div>
</div>
</div>
</div>
<p>and then invoke <code class="docutils literal notranslate"><span class="pre">anaddb</span></code> to compute phonon bands and DOS:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">phbst</span><span class="p">,</span> <span class="n">phdos</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">anaget_phbst_and_phdos_files</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Finally we plot the results with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">phbst</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">plot_with_phdos</span><span class="p">(</span><span class="n">phdos</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_57_0.png" src="../_images/lesson_eph_al_57_0.png" />
</div>
</div>
<p>The vibrational spectrum seems OK but remember that we are <em>enforcing</em> the acoustic sum rule
with <code class="docutils literal notranslate"><span class="pre">asr</span></code>.
Since our input parameters are underconverged, its a good idea to compare the spectrum with/without <code class="docutils literal notranslate"><span class="pre">asr</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ph_plotter</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">anacompare_asr</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ph_plotter</span><span class="o">.</span><span class="n">combiplot</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;cm-1&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_60_0.png" src="../_images/lesson_eph_al_60_0.png" />
</div>
</div>
<div class="alert alert-warning" role="alert">
Not so good! The breaking of the ASR is quite large.
This is mainly due to the use of a too small value for `ecut`.
In real life, we should increase `ecut` and rerun the DFPT part but since this is a tutorial
aiming at showing how to perform EPH calculations, we ignore this convergence issue 
keeping in mind that we should redo all our calculations with larger ecut before submitting the final
version of the paper!
</div>
<p>We can now finally turn our attention to the phonon linewidths and the Eliashberg function.</p>
</div>
<div class="section" id="phonon-linewidths-and-eliashberg-function">
<h2>Phonon linewidths and Eliashberg function<a class="headerlink" href="#phonon-linewidths-and-eliashberg-function" title="Permalink to this headline">¶</a></h2>
<p>We have generated a pair of <code class="docutils literal notranslate"><span class="pre">DDB</span></code>-<code class="docutils literal notranslate"><span class="pre">DVDB</span></code> files on a 4x4x4 q-mesh
and <strong>three</strong> <code class="docutils literal notranslate"><span class="pre">WFK</span></code> files with a much denser k-sampling (x16, x24, x32).
In total we have three EPH calculations done with different k-meshes to analyze.</p>
<p>Let’s focus on the output files produced with the 16x16x16 k-mesh by the first <code class="docutils literal notranslate"><span class="pre">EphTask</span></code> in <code class="docutils literal notranslate"><span class="pre">w2/t0</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>ls flow_eph_al/w2/t0/outdata
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>out_A2F.nc
</pre></div>
</div>
</div>
</div>
<p>The most important results are stored in:</p>
<ul class="simple">
<li><p><em>out_A2F.nc</em>: main results in netcdf format</p></li>
<li><p><em>out_PHDOS.nc</em>: phonon DOS and projections over atoms and directions</p></li>
<li><p><em>out_PBSTS.nc</em>: phonon band structure along the q-path</p></li>
</ul>
<div class="alert alert-info" role="alert">
There is also a bunch of text files with the same results in text format if you are a gnuplot/xmgrace aficionado...
</div><p>Let’s get a quick summary of the most important results with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a2fnc</span> <span class="o">=</span> <span class="n">abilab</span><span class="o">.</span><span class="n">abiopen</span><span class="p">(</span><span class="s2">&quot;flow_eph_al/w2/t0/outdata/out_A2F.nc&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a2fnc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>================================= File Info =================================
Name: out_A2F.nc
Directory: /Users/gmatteo/git_repos/abipy_book/abipy_book/eph_al/flow_eph_al/w2/t0/outdata
Size: 254.68 kb
Access Time: Thu Jul  8 02:48:30 2021
Modification Time: Thu Jul  8 02:05:05 2021
Change Time: Thu Jul  8 02:05:05 2021

================================= Structure =================================
Full Formula (Al1)
Reduced Formula: Al
abc   :   2.806386   2.806386   2.806386
angles:  60.000000  60.000000  60.000000
Sites (1)
  #  SP      a    b    c
---  ----  ---  ---  ---
  0  Al      0    0    0

Abinit Spacegroup: spgid: 0, num_spatial_symmetries: 48, has_timerev: True, symmorphic: False

============================== Electronic Bands ==============================
Number of electrons: 3.0, Fermi level: 7.166 (eV)
nsppol: 1, nkpt: 145, mband: 4, nspinor: 1, nspden: 1
smearing scheme: gaussian (occopt 7), tsmear_eV: 1.088

================================ Phonon Bands ================================
Number of q-points: 198
Atomic mass units: {13.0: 26.981539}
Has non-analytical contribution for q --&gt; 0: False

============================== E-PH calculation ==============================
K-mesh for electrons:
mpdivs: [16 16 16] with shifts [[0. 0. 0.]] and kptopt: 1

a2f(w) on the [8 8 8] q-mesh (ddb_ngqpt|eph_ngqpt)
Isotropic lambda: 0.25, omega_log: 0.030 (eV), 343.094 (K)

a2f(w) Fourier interpolated on the [24 24 24] q-mesh (ph_ngqpt)
Isotropic lambda: 0.26, omega_log: 0.027 (eV), 314.268 (K)
</pre></div>
</div>
</div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">E-PH</span> <span class="pre">calculation</span></code> we have the value of <span class="math notranslate nohighlight">\(\lambda\)</span> and <span class="math notranslate nohighlight">\(\omega_{log}\)</span> computed
with a 16x16x16 k-mesh for electrons and two q-meshes.
…</p>
<p>The value of <span class="math notranslate nohighlight">\(\lambda\)</span> is smaller (almost a factor 2) with respect to other values
reported in the literature, likely due to the coarse 12x12x12 k-sampling.
We will investigate this problem in the next section.
For the time being, we prefer to focus on the visualization of the results with AbiPy.</p>
<p>Let’s use matplotlib to plot the Eliashberg function obtained with the two q-meshes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a2fnc</span><span class="o">.</span><span class="n">plot_a2f_interpol</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_68_0.png" src="../_images/lesson_eph_al_68_0.png" />
</div>
</div>
<p>This Eliashberg function obtained on the [24, 24, 24] q-mesh looks nicer, in particular
we see the appearance of Van Hove singularities.
As expected, the integral <span class="math notranslate nohighlight">\(\lambda(\omega)\)</span> is less sensitive to the interpolation in q-space.
We conclude that the fact that our <span class="math notranslate nohighlight">\(\lambda\)</span> is too small when compared with other ab-initio calculations (<span class="math notranslate nohighlight">\(\lambda \approx 0.4\)</span>)
is not related to the q-sampling but to the <em>quality</em> of our phonon linewidths that in turn is related
to the description of the FS.</p>
<p>We can also visualize the phonon linewidths with a scatter plot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a2fnc</span><span class="o">.</span><span class="n">plot_with_a2f</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;meV&quot;</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;gamma&quot;</span><span class="p">);</span>
<span class="c1">#a2fnc.plot(units=&quot;meV&quot;, what=&quot;gamma&quot;);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_71_0.png" src="../_images/lesson_eph_al_71_0.png" />
</div>
</div>
<p>To plot the band energies used in the calculation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#a2fnc.plot_ebands();</span>
</pre></div>
</div>
</div>
</div>
<!--
To plot the phonon frequencies, the linewidths $\gamma_{{\bf q}, \nu}$ 
and $\lambda_{{\bf q}, \nu}$ on the same figure, use:
a2fnc.plot_eph_strength();

In principle, the linewidth of the acoustic modes should go to zero for $q \rightarrow 0$.

#a2fnc.a2f_qintp.get_mcmillan_tc(mustar=0.1)
#a2fnc.a2f_qcoarse.plot_tc_vs_mustar();
--><p>The notation <span class="math notranslate nohighlight">\(\alpha^2 F(\omega)\)</span> was introduced because the Eliashberg function
is usually proportional to the phonon DOS <span class="math notranslate nohighlight">\(F(\omega)\)</span>.
There are, however, exceptions so it is useful to plot <span class="math notranslate nohighlight">\(\alpha^2F(\omega)\)</span>, <span class="math notranslate nohighlight">\(F(\omega)\)</span> and their ratio <span class="math notranslate nohighlight">\(\alpha^2\)</span>.</p>
<p>It is just a matter of passing the phonon DOS computed from the <code class="docutils literal notranslate"><span class="pre">DDB</span></code> file in the previous section
to the <code class="docutils literal notranslate"><span class="pre">plot_a2</span></code> method:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a2fnc</span><span class="o">.</span><span class="n">a2f_qcoarse</span><span class="o">.</span><span class="n">plot_a2</span><span class="p">(</span><span class="n">phdos</span><span class="o">=</span><span class="n">phdos</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_76_0.png" src="../_images/lesson_eph_al_76_0.png" />
</div>
</div>
<p>To conclude this section: our results for <span class="math notranslate nohighlight">\(\lambda\)</span> and <span class="math notranslate nohighlight">\(\alpha^2F(\omega)\)</span> look reasonable
but we are still far from the results reported in previous works.
Perhaps we are not completely converged and we should analyze in more detail
what happens if we increase the k-point sampling.
Fortunately we have already computed these results in our Flow so it is just a matter of using
AbiPy to compare multiple calculations.</p>
</div>
<div class="section" id="using-the-a2frobot-for-convergence-studies">
<h2>Using the A2FRobot for convergence studies<a class="headerlink" href="#using-the-a2frobot-for-convergence-studies" title="Permalink to this headline">¶</a></h2>
<p>In this section, we use the <code class="docutils literal notranslate"><span class="pre">A2fRobot</span></code> to analyze the convergence behaviour of our results
with respect to the k-point sampling in the double-delta integral.</p>
<p>Let’s ask our robot to open all the <code class="docutils literal notranslate"><span class="pre">A2F</span></code> files  located within the <code class="docutils literal notranslate"><span class="pre">flow_eph_al/</span></code> directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">robot</span> <span class="o">=</span> <span class="n">abilab</span><span class="o">.</span><span class="n">A2fRobot</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="s2">&quot;flow_eph_al/&quot;</span><span class="p">)</span>
<span class="n">robot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><ol start="0">
<li>w2/t2/outdata/out_A2F.nc</li>
<li>w2/t1/outdata/out_A2F.nc</li>
<li>w2/t0/outdata/out_A2F.nc</li>
</ol></div></div>
</div>
<p>We know that all these calculations have been done with different values of <code class="docutils literal notranslate"><span class="pre">nkpt</span></code>.
Let’s change the labels of the files by replacing file paths with more informative strings:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">robot</span><span class="o">.</span><span class="n">remap_labels</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ncfile</span><span class="p">:</span> <span class="s2">&quot;nkpt: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OrderedDict([(&#39;nkpt: 897&#39;, &#39;w2/t2/outdata/out_A2F.nc&#39;),
             (&#39;nkpt: 413&#39;, &#39;w2/t1/outdata/out_A2F.nc&#39;),
             (&#39;nkpt: 145&#39;, &#39;w2/t0/outdata/out_A2F.nc&#39;)])
</pre></div>
</div>
</div>
</div>
<p>and print a pandas <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> with the parameters of the calculation can help to understand the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">robot</span><span class="o">.</span><span class="n">get_params_dataframe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>nsppol</th>
      <th>nspinor</th>
      <th>nspden</th>
      <th>nband</th>
      <th>nkpt</th>
      <th>ddb_nqbz</th>
      <th>eph_nqbz_fine</th>
      <th>ph_nqbz</th>
      <th>eph_intmeth</th>
      <th>eph_fsewin</th>
      <th>eph_fsmear</th>
      <th>eph_extrael</th>
      <th>eph_fermie</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>nkpt: 897</th>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
      <td>897</td>
      <td>64</td>
      <td>512</td>
      <td>13824</td>
      <td>2</td>
      <td>0.029399</td>
      <td>0.01</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>nkpt: 413</th>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
      <td>413</td>
      <td>64</td>
      <td>512</td>
      <td>13824</td>
      <td>2</td>
      <td>0.029399</td>
      <td>0.01</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>nkpt: 145</th>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
      <td>145</td>
      <td>64</td>
      <td>512</td>
      <td>13824</td>
      <td>2</td>
      <td>0.029399</td>
      <td>0.01</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>As usual, it is much easier to analyze the convergence of scalar quantities.
Since we are mainly interested in <span class="math notranslate nohighlight">\(T_c\)</span>-related properties, it makes sense
to print a table with the value of <span class="math notranslate nohighlight">\(\lambda\)</span> and <span class="math notranslate nohighlight">\(\omega_{log}\)</span> extracted from the different calculations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">robot</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span><span class="n">with_params</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lambda_qcoarse</th>
      <th>omegalog_qcoarse</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>nkpt: 897</th>
      <td>0.386603</td>
      <td>0.028770</td>
    </tr>
    <tr>
      <th>nkpt: 413</th>
      <td>0.373353</td>
      <td>0.029148</td>
    </tr>
    <tr>
      <th>nkpt: 145</th>
      <td>0.248242</td>
      <td>0.029566</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>This table gives the values integrated on the <code class="docutils literal notranslate"><span class="pre">eph_ngqpt</span></code> mesh as well as the values obtained
by Fourier interpolating the results on the <code class="docutils literal notranslate"><span class="pre">ph_ngqpt</span></code> mesh.
Note the <strong>big jump</strong> in <span class="math notranslate nohighlight">\(\lambda\)</span> when we go from the 18x18x18 k-mesh to the 36x36x36 k-mesh (~0.2 –&gt; ~0.4).
This clearly shows that our initial estimate for <span class="math notranslate nohighlight">\(\lambda\)</span> obtained with a 18x18x18 k-mesh was really bad!
(Did I tell you that these calculations are very sensitive to the k-point sampling?)</p>
<p>If you prefer figures instead of tables with numbers, just use:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">robot</span><span class="o">.</span><span class="n">plot_a2fdata_convergence</span><span class="p">(</span><span class="n">sortby</span><span class="o">=</span><span class="s2">&quot;nkpt&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_87_0.png" src="../_images/lesson_eph_al_87_0.png" />
</div>
</div>
<p>When converging with respect to the number of k-points, it is common to plot the
physical results as function of <span class="math notranslate nohighlight">\(\frac{1}{N_{kpt}}\)</span>.
Let’s define a small function that tells our robot how to sort the results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">inv_nkpt</span><span class="p">(</span><span class="n">a2f_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;$\dfrac{1}{N_k}$&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span> <span class="n">a2f_file</span><span class="o">.</span><span class="n">nkpt</span>
    
<span class="n">robot</span><span class="o">.</span><span class="n">plot_a2fdata_convergence</span><span class="p">(</span><span class="n">sortby</span><span class="o">=</span><span class="n">inv_nkpt</span><span class="p">);</span> <span class="c1">#, hue=&quot;eph_fsmear&quot;);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_89_0.png" src="../_images/lesson_eph_al_89_0.png" />
</div>
</div>
<p>At this point, our estimate for <span class="math notranslate nohighlight">\(\lambda\)</span> should be somewhere in [0.39, 0.42]
that compares much better with the value of 0.44 reported by Savrasov.
<strong>Most importantly</strong>, our results started to converge (although slowly).
Now we know that a serious calculation of the phonon linewidths of Al
would require something around 32x32x32 k-points (this is indeed the mesh used by Savrasov in their paper).</p>
<p>So far, we have been focusing on <span class="math notranslate nohighlight">\(\lambda\)</span> but what about the convergence of <span class="math notranslate nohighlight">\(\alpha^2F(\omega)\)</span>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">robot</span><span class="o">.</span><span class="n">plot_a2f_convergence</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/lesson_eph_al_92_0.png" src="../_images/lesson_eph_al_92_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>================================= File Info =================================
Name: out_A2F.nc
Directory: /Users/gmatteo/git_repos/abipy_book/abipy_book/eph_al/flow_eph_al/w2/t0/outdata
Size: 254.68 kb
Access Time: Thu Jul  8 02:48:30 2021
Modification Time: Thu Jul  8 02:05:05 2021
Change Time: Thu Jul  8 02:05:05 2021

================================= Structure =================================
Full Formula (Al1)
Reduced Formula: Al
abc   :   2.806386   2.806386   2.806386
angles:  60.000000  60.000000  60.000000
Sites (1)
  #  SP      a    b    c
---  ----  ---  ---  ---
  0  Al      0    0    0

Abinit Spacegroup: spgid: 0, num_spatial_symmetries: 48, has_timerev: True, symmorphic: False

============================== Electronic Bands ==============================
Number of electrons: 3.0, Fermi level: 7.166 (eV)
nsppol: 1, nkpt: 145, mband: 4, nspinor: 1, nspden: 1
smearing scheme: gaussian (occopt 7), tsmear_eV: 1.088

================================ Phonon Bands ================================
Number of q-points: 198
Atomic mass units: {13.0: 26.981539}
Has non-analytical contribution for q --&gt; 0: False

============================== E-PH calculation ==============================
K-mesh for electrons:
mpdivs: [16 16 16] with shifts [[0. 0. 0.]] and kptopt: 1

a2f(w) on the [8 8 8] q-mesh (ddb_ngqpt|eph_ngqpt)
Isotropic lambda: 0.25, omega_log: 0.030 (eV), 343.094 (K)

a2f(w) Fourier interpolated on the [24 24 24] q-mesh (ph_ngqpt)
Isotropic lambda: 0.26, omega_log: 0.027 (eV), 314.268 (K)
</pre></div>
</div>
</div>
</div>
<p>Other post-processing tools:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#robot.gridplot_a2f(tight_layout=True);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#robot.plot_a2f_convergence(sortby=&quot;nkpt&quot;, hue=&quot;eph_fsmear&quot;, tight_layout=True);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#robot.plot_lambda_convergence(what=&quot;gamma&quot;, sortby=&quot;nkpt&quot;, hue=&quot;eph_fsmear&quot;, tight_layout=True);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#robot.abifiles[-1].plot_a2f_interpol();</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#robot.abifiles[-1].a2f_qcoarse.plot_tc_vs_mustar(start=0.1, stop=0.2);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#robot.gridplot_phbands_with_a2f(units=&quot;meV&quot;);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#robot.plot_a2fdata_convergence(sortby=&quot;nkpt&quot;, hue=None);</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./eph_al"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="../bse/lesson_bse.html" title="previous page">Bethe-Salpeter calculations with AbiPy</a>
    <a class='right-next' id="next-link" href="../links.html" title="next page">Useful links</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By M. Giantomassi and the AbiPy group<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>